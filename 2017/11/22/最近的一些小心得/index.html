<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Begin头条面试失利, 折的莫名其妙, 不知道为啥. 可能没有这个缘分吧. 不过过程中还是学到了一些东西的, 这里总结一下. 失败后郁郁寡欢, 那是懦夫的表现, 虽然人的性格可以刻意去调整, 但是无法改变, 但是我愿意为遇到更好的自己而努力. 接下来对面试中的一些问题进行总结, 并转化为生产力. 由于要结合具体的场景, 所以更新略慢.">
<meta name="keywords" content="RxSwift">
<meta property="og:type" content="article">
<meta property="og:title" content="最近的一些小心得">
<meta property="og:url" content="http://yoursite.com/2017/11/22/最近的一些小心得/index.html">
<meta property="og:site_name" content="ArthurChi&#39;s Blog">
<meta property="og:description" content="Begin头条面试失利, 折的莫名其妙, 不知道为啥. 可能没有这个缘分吧. 不过过程中还是学到了一些东西的, 这里总结一下. 失败后郁郁寡欢, 那是懦夫的表现, 虽然人的性格可以刻意去调整, 但是无法改变, 但是我愿意为遇到更好的自己而努力. 接下来对面试中的一些问题进行总结, 并转化为生产力. 由于要结合具体的场景, 所以更新略慢.">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://7xpsbt.com1.z0.glb.clouddn.com/%E9%83%81%E9%83%81%E5%AF%A1%E6%AC%A2%E4%B9%88.gif">
<meta property="og:image" content="http://7xpsbt.com1.z0.glb.clouddn.com/Dispatch-Barrier-Swift.png">
<meta property="og:updated_time" content="2017-11-30T01:29:59.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="最近的一些小心得">
<meta name="twitter:description" content="Begin头条面试失利, 折的莫名其妙, 不知道为啥. 可能没有这个缘分吧. 不过过程中还是学到了一些东西的, 这里总结一下. 失败后郁郁寡欢, 那是懦夫的表现, 虽然人的性格可以刻意去调整, 但是无法改变, 但是我愿意为遇到更好的自己而努力. 接下来对面试中的一些问题进行总结, 并转化为生产力. 由于要结合具体的场景, 所以更新略慢.">
<meta name="twitter:image" content="http://7xpsbt.com1.z0.glb.clouddn.com/%E9%83%81%E9%83%81%E5%AF%A1%E6%AC%A2%E4%B9%88.gif">





  
  
  <link rel="canonical" href="http://yoursite.com/2017/11/22/最近的一些小心得/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>最近的一些小心得 | ArthurChi's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ArthurChi's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Yesterday you said tomorrow</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/22/最近的一些小心得/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Author">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ArthurChi's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">最近的一些小心得

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-11-22 18:03:01" itemprop="dateCreated datePublished" datetime="2017-11-22T18:03:01+08:00">2017-11-22</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2017-11-30 09:29:59" itemprop="dateModified" datetime="2017-11-30T09:29:59+08:00">2017-11-30</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Begin"><a href="#Begin" class="headerlink" title="Begin"></a>Begin</h1><p>头条面试失利, 折的莫名其妙, 不知道为啥. 可能没有这个缘分吧. 不过过程中还是学到了一些东西的, 这里总结一下. 失败后郁郁寡欢, 那是懦夫的表现, 虽然人的性格可以刻意去调整, 但是无法改变, 但是我愿意为遇到更好的自己而努力. 接下来对面试中的一些问题进行总结, 并转化为生产力. 由于要结合具体的场景, 所以更新略慢.</p>
<a id="more"></a>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p><img src="http://7xpsbt.com1.z0.glb.clouddn.com/%E9%83%81%E9%83%81%E5%AF%A1%E6%AC%A2%E4%B9%88.gif" alt="不就是面试失利么?"></p>
<ol>
<li>moya的重复请求的处理, 以及一些面试中遇到的相关问题.</li>
<li>阅读项目 <code>concat</code> 三级缓存.</li>
<li>throttle &amp; debounce 区别</li>
<li>ABI稳定</li>
</ol>
<h1 id="Moya的重复请求的处理"><a href="#Moya的重复请求的处理" class="headerlink" title="Moya的重复请求的处理"></a>Moya的重复请求的处理</h1><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>在参考了SD后, 发现他在发起一个请求之前会先看当前请求是否已经存在, 如果已经存在, 那么就将block加入到对应的数组中去.</p>
<h2 id="Learn-more"><a href="#Learn-more" class="headerlink" title="Learn more"></a>Learn more</h2><p>但是在找这个代码过程中, 意外收获了一点学习模式, 我觉得这是一个里程碑式的事情, 需要记录一下. 这种模式就是通过issue和修复过程来学习经验. 这种方式应该早就存在了, 只是自己愚钝的很才发现.</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>检查内存缓存, 如果没有, 则检查磁盘缓存, 如果没有, 则检查下载队列, 如果正在下载, 则将block添加到对应的数组中, 如果没有, 则创建下载任务.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">- (nullable SDWebImageDownloadToken *)addProgressCallback:(SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                                           completedBlock:(SDWebImageDownloaderCompletedBlock)completedBlock</span><br><span class="line">                                                   forURL:(nullable NSURL *)url</span><br><span class="line">                                           createCallback:(SDWebImageDownloaderOperation *(^)(void))createCallback &#123;</span><br><span class="line">    // The URL will be used as the key to the callbacks dictionary so it cannot be nil. If it is nil immediately call the completed block with no image or data.</span><br><span class="line">    if (url == nil) &#123;</span><br><span class="line">        if (completedBlock != nil) &#123;</span><br><span class="line">            completedBlock(nil, nil, nil, NO);</span><br><span class="line">        &#125;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __block SDWebImageDownloadToken *token = nil;</span><br><span class="line"></span><br><span class="line">    dispatch_barrier_sync(self.barrierQueue, ^&#123;</span><br><span class="line">        SDWebImageDownloaderOperation *operation = self.URLOperations[url];</span><br><span class="line">        if (!operation) &#123;</span><br><span class="line">            operation = createCallback();</span><br><span class="line">            self.URLOperations[url] = operation;</span><br><span class="line"></span><br><span class="line">            __weak SDWebImageDownloaderOperation *woperation = operation;</span><br><span class="line">            operation.completionBlock = ^&#123;</span><br><span class="line">				dispatch_barrier_sync(self.barrierQueue, ^&#123;</span><br><span class="line">					SDWebImageDownloaderOperation *soperation = woperation;</span><br><span class="line">					if (!soperation) return;</span><br><span class="line">					if (self.URLOperations[url] == soperation) &#123;</span><br><span class="line">						[self.URLOperations removeObjectForKey:url];</span><br><span class="line">					&#125;;</span><br><span class="line">				&#125;);</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        id downloadOperationCancelToken = [operation addHandlersForProgress:progressBlock completed:completedBlock];</span><br><span class="line"></span><br><span class="line">        token = [SDWebImageDownloadToken new];</span><br><span class="line">        token.url = url;</span><br><span class="line">        token.downloadOperationCancelToken = downloadOperationCancelToken;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里在bug修复日志中, 可以看到这样的一则修改:</p>
<blockquote>
<p>fixed crash on multiple concurrent downloads when accessing <code>self.URLOperations</code> dictionary #1911 fixes #1909 #1950 #1835 #1838</p>
</blockquote>
<p>从issues中看到, 最终使用了1911的方案, 也就是使用 <code>dispatch_barrier_sync</code>来修复这个bug. but why?</p>
<h2 id="Barrier"><a href="#Barrier" class="headerlink" title="Barrier"></a>Barrier</h2><p>提到Barrier, 我们通常管他叫栅栏函数. 他的作用如下图(引子<a href="https://www.raywenderlich.com/148513/grand-central-dispatch-tutorial-swift-3-part-1" target="_blank" rel="noopener">这里</a>)</p>
<p><img src="http://7xpsbt.com1.z0.glb.clouddn.com/Dispatch-Barrier-Swift.png" alt></p>
<p>正如你所看到的, barrier可以将并行转为串行. 他会等待之前的提交的block执行完后, 再进行执行. 这里有同步和异步两种方式, 同步的则是阻塞当前线程, 异步的则是立刻返回, 而不阻塞当前线程. 那么我们看SD这里是怎么修复的. </p>
<h3 id="新建一个并行队列-barrierQueue"><a href="#新建一个并行队列-barrierQueue" class="headerlink" title="新建一个并行队列 barrierQueue"></a>新建一个并行队列 barrierQueue</h3><blockquote>
<p>Notice how in normal operation the queue acts just like a normal concurrent queue. But when the barrier is executing, it essentially acts like a serial queue. </p>
</blockquote>
<p>那么两个问题: </p>
<ol>
<li>为什么不使用串行队列</li>
<li>为什么不使用全局队列</li>
</ol>
<p>第一个问题, 在我们的例子中, 需要用到sync进行任务执行, 如果使用串行队列, 那么, 很容易就造成死锁. </p>
<p>第二个问题, 为什么不使用全局队列, 这个问题, 我查了好久的资料, 在<a href="https://stackoverflow.com/questions/9602042/whats-the-difference-between-the-global-queue-and-the-main-queue-in-gcd" target="_blank" rel="noopener">这里</a>找到了答案. </p>
<blockquote>
<p>they are queues which run on background threads as and when they become available. They’re “non-FIFO” so ordering is not guaranteed.</p>
</blockquote>
<p>我们使用队列的初衷就是FIFO, 如果失去了这个特性, 那么将会造成不可预知的结果, 也就意味着会产生莫名其妙的bug. </p>
<p>综上所述, 创建一个自定义的并行队列是很合理也很合逻辑的.</p>
<h3 id="将Dictionary的写入做了一个同步的Barrier"><a href="#将Dictionary的写入做了一个同步的Barrier" class="headerlink" title="将Dictionary的写入做了一个同步的Barrier"></a>将Dictionary的写入做了一个同步的Barrier</h3><p>将URL作为key, Operation作为Value.<br>这里使用同步栅栏函数而不是异步的, 是因为这里的token需要作为返回值而存在, 如果使用异步, 则会返回一个nil的对象, 这不是我们想要的.</p>
<h3 id="当任务完成-同步执行一段移除代码"><a href="#当任务完成-同步执行一段移除代码" class="headerlink" title="当任务完成, 同步执行一段移除代码"></a>当任务完成, 同步执行一段移除代码</h3><p>override的completionBlock, 在任务完成后, 将上述的operation移出字典. 那么这里也是用的sync, 这里我想了好久, 并自己写了个小demo, 反复思考后, 想明白了, 这里之所以用sync是因为要阻塞操作线程, 那是为什么呢? please imagine this, 如果这里使用异步, 而后面恰好有一个相同的URL的key的操作, 那么会不会造成混乱, 所以这里需要使用同步, 阻塞掉操作线程, 保证没有脏数据的出现.</p>
<h1 id="生产力的转化"><a href="#生产力的转化" class="headerlink" title="生产力的转化"></a>生产力的转化</h1><p>在写阅读插件的service层的时候, 对于发送的请求, 如果再有对该请求感兴趣的行为, 可以直接对observable进行观察.<br>在<a href="http://beetree.top/2017/10/19/%E4%B8%80%E4%B8%AA%E9%98%85%E8%AF%BB%E5%99%A8-%E4%BA%8C/" target="_blank" rel="noopener">之前的文章中</a>说道了netservice, 现在看来, 不仅需要加这个功能, 而且需要简化一下代码, 有些过于啰嗦的地方.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">class NetWorkService&lt;T: TargetType&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    private var requestQueue = Dictionary&lt;Int, Any&gt;()</span><br><span class="line">    private var barrierQueue = DispatchQueue(label: &quot;com.sina.read.barrierQueue&quot;, attributes: .concurrent)</span><br><span class="line">    </span><br><span class="line">    fileprivate lazy var sessionManager: SessionManager = &#123;</span><br><span class="line">        </span><br><span class="line">        let configuration = URLSessionConfiguration.default</span><br><span class="line">        configuration.timeoutIntervalForRequest = 15</span><br><span class="line">        </span><br><span class="line">        return SessionManager(configuration: configuration)</span><br><span class="line">    &#125;()</span><br><span class="line">    </span><br><span class="line">    fileprivate var provider: MoyaProvider&lt;T&gt;</span><br><span class="line">    var reachabilityManger = NetworkReachabilityManager()!</span><br><span class="line">    </span><br><span class="line">    init() &#123;</span><br><span class="line">        </span><br><span class="line">        // Endpoint</span><br><span class="line">        let endpointClosure = &#123; (target: T) -&gt; Endpoint&lt;T&gt; in</span><br><span class="line">            let defaultEndpoint = MoyaProvider.defaultEndpointMapping(for: target)</span><br><span class="line">            </span><br><span class="line">            switch defaultEndpoint.task &#123;</span><br><span class="line">            case .requestParameters(parameters: let params, encoding: let encoding):</span><br><span class="line">                var tmpParams = params</span><br><span class="line">                tmpParams[&quot;authcode&quot;] = Marco.URL.authcode</span><br><span class="line">                return defaultEndpoint.replacing(task: Task.requestParameters(parameters: tmpParams, encoding: encoding))</span><br><span class="line">            default:</span><br><span class="line">                return defaultEndpoint</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // Manager</span><br><span class="line">        let configuration = URLSessionConfiguration.default</span><br><span class="line">        configuration.timeoutIntervalForRequest = 15</span><br><span class="line">        </span><br><span class="line">        let sessionManager = SessionManager(configuration: configuration)</span><br><span class="line">        </span><br><span class="line">        provider = MoyaProvider&lt;T&gt;(endpointClosure: endpointClosure, manager: sessionManager)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    func requestBool(reqType: T) -&gt; Observable&lt;Bool&gt; &#123;</span><br><span class="line">        return request(reqType: reqType, transformer: &#123; dict in</span><br><span class="line">            // 如果走到这里, 说明状态码都没有问题, 可以直接返回true</span><br><span class="line">            return true</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func requestObject&lt;U: Mappable&gt;(reqType: T, byKey: String = &quot;&quot;) -&gt; Observable&lt;U&gt; &#123;</span><br><span class="line">        </span><br><span class="line">        return request(reqType: reqType, transformer: &#123; dict in</span><br><span class="line">            </span><br><span class="line">            var data = dict</span><br><span class="line">            </span><br><span class="line">            if !byKey.isEmpty, let specialDict = data[byKey] as? [String: Any] &#123;</span><br><span class="line">                data = specialDict</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if let result = Mapper&lt;U&gt;().map(JSON: data) &#123;</span><br><span class="line">                return result</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            throw CustomError.mapJsonError</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func requestCollection&lt;U: Mappable&gt;(reqType: T, byKey: String = &quot;&quot;) -&gt; Observable&lt;[U]&gt; &#123;</span><br><span class="line">        </span><br><span class="line">        return request(reqType: reqType, transformer: &#123; dict in</span><br><span class="line">            </span><br><span class="line">            var data = dict</span><br><span class="line">            </span><br><span class="line">            if !byKey.isEmpty, let specialDict = data[byKey] as? Array&lt;Dictionary&lt;String, Any&gt;&gt; &#123;</span><br><span class="line">                return Mapper&lt;U&gt;().mapArray(JSONArray: specialDict)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if let datas = data[&quot;data&quot;] as? Array&lt;[String: Any]&gt; &#123;</span><br><span class="line">                return Mapper&lt;U&gt;().mapArray(JSONArray: datas)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            throw CustomError.mapJsonError</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private func request&lt;R&gt;(reqType: T, transformer: @escaping (Dictionary&lt;String, Any&gt;) throws -&gt; R) -&gt; Observable&lt;R&gt; &#123;</span><br><span class="line">        </span><br><span class="line">        let requestHash: Int = provider.endpoint(reqType).hashValue</span><br><span class="line">        </span><br><span class="line">        var observableResult: Observable&lt;R&gt;? = nil</span><br><span class="line">        </span><br><span class="line">        barrierQueue.sync &#123;</span><br><span class="line">            if let observable = requestQueue[requestHash] as? Observable&lt;R&gt; &#123;</span><br><span class="line">                observableResult = observable</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if observableResult != nil &#123;</span><br><span class="line">            return observableResult!</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        let result: Observable&lt;R&gt; =</span><br><span class="line">            provider</span><br><span class="line">                .rx</span><br><span class="line">                .request(reqType)</span><br><span class="line">                .asObservable()</span><br><span class="line">                .convenienceObserveOn(scheduler: .serial(.default))</span><br><span class="line">                .mapJSON()</span><br><span class="line">                .share(replay: 1)</span><br><span class="line">                .filterError()</span><br><span class="line">                .map(transformer)</span><br><span class="line">                .do &#123; [unowned self] in</span><br><span class="line">                    self.barrierQueue.async(flags: .barrier) &#123;</span><br><span class="line">                        self.requestQueue.removeValue(forKey: requestHash)</span><br><span class="line">                    &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        barrierQueue.async(flags: .barrier) &#123;</span><br><span class="line">            self.requestQueue[requestHash] = result</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        return result</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要的优化部分有:</p>
<ol>
<li>对于已经发送中的请求, 不进行重复发送, 而是将observable返回, 以便观察使用. 这个过程中, 使用上述的SD那些东西. ^_^学以致用</li>
<li>将重复的代码进行抽取, 不啰嗦.</li>
</ol>
<h1 id="End"><a href="#End" class="headerlink" title="End"></a>End</h1><p>先写到这里, 这几天准备离开北京去深圳, 非常感谢妻子在这过程中将一些繁杂的事情全都搞定, 可以让我安心学习优化代码. </p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote>
<p><a href="https://www.raywenderlich.com/148513/grand-central-dispatch-tutorial-swift-3-part-1" target="_blank" rel="noopener">https://www.raywenderlich.com/148513/grand-central-dispatch-tutorial-swift-3-part-1</a><br><a href="https://www.raywenderlich.com/148515/grand-central-dispatch-tutorial-swift-3-part-2" target="_blank" rel="noopener">https://www.raywenderlich.com/148515/grand-central-dispatch-tutorial-swift-3-part-2</a><br><a href="https://stackoverflow.com/questions/9602042/whats-the-difference-between-the-global-queue-and-the-main-queue-in-gcd" target="_blank" rel="noopener">https://stackoverflow.com/questions/9602042/whats-the-difference-between-the-global-queue-and-the-main-queue-in-gcd</a></p>
</blockquote>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/RxSwift/" rel="tag"># RxSwift</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/08/项目Swift4升级伪指北/" rel="next" title="项目Swift4升级伪指北">
                <i class="fa fa-chevron-left"></i> 项目Swift4升级伪指北
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/29/最近一些小心得-二/" rel="prev" title="最近一些小心得(二)">
                最近一些小心得(二) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Author</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">97</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">categories</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">92</span>
                    <span class="site-state-item-name">tags</span>
                  
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Begin"><span class="nav-number">1.</span> <span class="nav-text">Begin</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#目标"><span class="nav-number">2.</span> <span class="nav-text">目标</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Moya的重复请求的处理"><span class="nav-number">3.</span> <span class="nav-text">Moya的重复请求的处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#思路"><span class="nav-number">3.1.</span> <span class="nav-text">思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Learn-more"><span class="nav-number">3.2.</span> <span class="nav-text">Learn more</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流程"><span class="nav-number">3.2.1.</span> <span class="nav-text">流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Barrier"><span class="nav-number">3.3.</span> <span class="nav-text">Barrier</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#新建一个并行队列-barrierQueue"><span class="nav-number">3.3.1.</span> <span class="nav-text">新建一个并行队列 barrierQueue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将Dictionary的写入做了一个同步的Barrier"><span class="nav-number">3.3.2.</span> <span class="nav-text">将Dictionary的写入做了一个同步的Barrier</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#当任务完成-同步执行一段移除代码"><span class="nav-number">3.3.3.</span> <span class="nav-text">当任务完成, 同步执行一段移除代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#生产力的转化"><span class="nav-number">4.</span> <span class="nav-text">生产力的转化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#End"><span class="nav-number">5.</span> <span class="nav-text">End</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Author</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>



  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
